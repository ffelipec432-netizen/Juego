<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Rompecabezas Educativo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: linear-gradient(135deg, #1e1e2f, #2a2a4a); color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 100vh; }
    header { margin: 20px 0; text-align: center; }
    header h1 { font-size: 2rem; color: #00ffcc; text-shadow: 0 0 15px #00ffcc; margin: 0; }
    header p { color: #ddd; margin: 6px 0 0 0; }
    #main-container { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; max-width: 1200px; padding: 10px; }
    .side-text { width: 180px; font-size: 1rem; background: rgba(255,255,255,0.06); padding: 15px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.3); color: #fff; min-height: 120px; display: flex; align-items: center; justify-content: center; text-align: center; transition: opacity 0.6s; }
    #score-board { font-size: 1.2rem; font-weight: bold; margin: 8px; padding: 8px 16px; background: #00ffcc; color: #111; border-radius: 12px; box-shadow: 0 0 10px #00ffcc; animation: pulse 1.8s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 8px #00ffcc; } 50% { box-shadow: 0 0 20px #00ffcc; } 100% { box-shadow: 0 0 8px #00ffcc; } }
    #puzzle-board { position: relative; width: 560px; height: 560px; display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 1fr); background: #222 center/cover no-repeat; border-radius: 12px; overflow: hidden; border: 4px solid rgba(0,255,204,0.16); }
    .tile { background: rgba(0,0,0,0.9); border: 1px solid rgba(255,255,255,0.04); cursor: pointer; transition: opacity 0.5s; }
    .tile.revealed { opacity: 0; pointer-events: none; }
    #quiz-container { display: none; position: fixed; top:50%; left:50%; transform:translate(-50%,-50%); background: linear-gradient(135deg,#4a00e0,#8e2de2); padding:20px; border-radius:12px; z-index:1200; width:320px; text-align:center; }
    .option { display:block; margin:10px auto; padding:10px 14px; border-radius:10px; border:none; background:#00ffcc; color:#111; font-weight:bold; cursor:pointer; }
    #final-panel { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.88); z-index:1400; color:#fff; text-align:center; padding-top:40px; }
    #final-panel .card { background: linear-gradient(180deg,#0f1724,#1b2336); margin: 0 auto; width:90%; max-width:720px; border-radius:14px; padding:20px; box-shadow: 0 10px 30px rgba(0,0,0,0.6); }
    #final-panel h1 { color:#00ffcc; text-shadow:0 0 12px #00ffcc; }
    #final-panel img { width:320px; border-radius:10px; margin-top:12px; }
    #download-btn { margin-top:14px; padding:12px 18px; border-radius:10px; border:none; background:#00ffcc; color:#111; font-weight:bold; cursor:pointer; }
    #name-modal { position:fixed; inset:0; background: rgba(0,0,0,0.9); display:flex; align-items:center; justify-content:center; z-index:2000; }
    #name-box { background:#fff; color:#111; padding:18px; border-radius:10px; width:320px; text-align:center; }
    #name-box input { width:100%; padding:10px; margin-top:8px; border-radius:8px; border:1px solid #ccc; box-sizing: border-box; font-size:16px; }
    #name-box button { margin-top:12px; padding:10px 14px; background:#00ffcc; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
    @media (max-width:800px){ #puzzle-board{ width:92vw; height:92vw; } .side-text{ display:none; } header h1{ font-size:1.6rem; } }
  </style>
</head>
<body>

<header>
  <h1>Rompecabezas Educativo</h1>
  <p>Aprende jugando y demuestra tu compromiso</p>
</header>

<div id="score-board">Puntaje: 0 | Tiempo: 03:00</div>

<div id="main-container">
  <div id="left-msg" class="side-text">Tu voz tiene poder</div>
  <div id="puzzle-board"></div>
  <div id="right-msg" class="side-text">No guardes silencio</div>
</div>

<div id="quiz-container">
  <h2 id="quiz-question"></h2>
  <div id="options"></div>
</div>

<div id="final-panel">
  <div class="card">
    <h1 id="final-score">Tu puntaje: 0/1000</h1>
    <p id="final-message">Mensaje</p>
    <img id="final-image" src="https://www.uautonoma.cl/content/uploads/2023/07/maltrato-infantil-1.jpg" alt="Imagen final">
    <div>
      <button id="download-btn">Descargar Certificado</button>
    </div>
  </div>
</div>

<!-- name modal -->
<div id="name-modal">
  <div id="name-box">
    <h2>Ingresa tu nombre</h2>
    <input id="player-name" placeholder="Tu nombre..." />
    <button id="start-btn">Comenzar</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  // --- estado global ---
  let playerName = '';
  let score = 0;
  let timeLeft = 180;
  let gameTimer = null;
  let gameStart = null;
  let revealedTiles = 0;
  let availableQuestions = [];

  // --- DOM refs (will be assigned after elements exist) ---
  let board, scoreBoard, quizContainer, quizQuestion, optionsDiv, finalPanel, finalScore, finalMessage, finalImage, downloadBtn, nameModal, playerNameInput, startBtn, leftMsg, rightMsg;

  // --- preguntas ---
  const questions = [
    {q: "¿Qué debes hacer si alguien te pide guardar un secreto que te incomoda?", a: "Contarlo a un adulto de confianza", o: ["Guardarlo", "Contarlo a un adulto de confianza", "Ignorarlo"]},
    {q: "Si un desconocido te ofrece regalos a cambio de favores, ¿qué haces?", a: "Rechazar y contarlo", o: ["Aceptarlo", "Rechazar y contarlo", "Guardarlo en secreto"]},
    {q: "¿Qué personas puedes buscar si necesitas ayuda?", a: "Familia, docentes, autoridades", o: ["Cualquier persona en la calle", "Familia, docentes, autoridades", "Nadie"]},
    {q: "¿Qué es el abuso sexual infantil?", a: "Contacto o acciones sexuales hacia un menor", o: ["Un juego entre amigos", "Contacto o acciones sexuales hacia un menor", "Un secreto"]},
    {q: "¿Qué número puedes marcar en Colombia para denunciar emergencias?", a: "141", o: ["321", "141", "911"]},
    {q: "Si un adulto toca tu cuerpo sin permiso, ¿qué debes hacer?", a: "Decir no y buscar ayuda", o: ["Quedarte callado", "Decir no y buscar ayuda", "Aceptar"]},
    {q: "¿El abuso sexual siempre implica violencia física?", a: "No, puede ser sin fuerza física", o: ["Sí, siempre", "No, puede ser sin fuerza física", "Nunca"]},
    {q: "¿Qué es el consentimiento?", a: "Aceptar libremente y sin presión", o: ["Aceptar por miedo", "Aceptar libremente y sin presión", "Obedecer"]},
    {q: "¿Qué debes hacer si un amigo te cuenta que fue víctima de abuso?", a: "Escuchar y buscar ayuda con un adulto", o: ["Ignorar", "Reírse", "Escuchar y buscar ayuda con un adulto"]},
    {q: "¿Qué lugar NO es seguro para conocer extraños en internet?", a: "Redes sociales", o: ["El colegio", "Redes sociales", "Biblioteca"]},
    {q: "¿Qué significa respetar los límites del cuerpo?", a: "No tocar sin permiso", o: ["Tocar cuando quieras", "No tocar sin permiso", "Obligar"]},
    {q: "¿Qué actitud es correcta frente al abuso?", a: "Denunciar y apoyar a la víctima", o: ["Culpar a la víctima", "Negar el problema", "Denunciar y apoyar a la víctima"]},
    {q: "¿Quiénes son responsables del abuso sexual?", a: "Los agresores", o: ["Los niños", "Los agresores", "Los amigos"]},
    {q: "¿Qué debes recordar sobre tu cuerpo?", a: "Tu cuerpo es tuyo y merece respeto", o: ["No importa", "Tu cuerpo es tuyo y merece respeto", "Otros deciden"]},
    {q: "¿Qué hacer si sientes miedo de denunciar?", a: "Hablar con alguien de confianza", o: ["Guardar silencio", "Hablar con alguien de confianza", "Huir"]},
    {q: "Si alguien te pide fotos íntimas por internet, ¿qué debes hacer?", a: "No enviar y avisar a un adulto", o: ["Enviar", "No enviar y avisar a un adulto", "Ignorar y seguir"]}
  ];

  // --- funciones (declaradas como funciones para que queden hoisted) ---
  function initDOMRefs(){
    board = document.getElementById('puzzle-board');
    scoreBoard = document.getElementById('score-board');
    quizContainer = document.getElementById('quiz-container');
    quizQuestion = document.getElementById('quiz-question');
    optionsDiv = document.getElementById('options');
    finalPanel = document.getElementById('final-panel');
    finalScore = document.getElementById('final-score');
    finalMessage = document.getElementById('final-message');
    finalImage = document.getElementById('final-image');
    downloadBtn = document.getElementById('download-btn');
    nameModal = document.getElementById('name-modal');
    playerNameInput = document.getElementById('player-name');
    startBtn = document.getElementById('start-btn');
    leftMsg = document.getElementById('left-msg');
    rightMsg = document.getElementById('right-msg');
  }

  function updateHUD(){
    const mm = String(Math.floor(timeLeft/60)).padStart(2,'0');
    const ss = String(timeLeft%60).padStart(2,'0');
    if(scoreBoard) scoreBoard.textContent = `Puntaje: ${score} | Tiempo: ${mm}:${ss}`;
  }

  function startGameTimer(){
    gameStart = Date.now();
    updateHUD();
    if(gameTimer) clearInterval(gameTimer);
    gameTimer = setInterval(()=>{
      timeLeft--;
      updateHUD();
      if(timeLeft<=0){ clearInterval(gameTimer); endGame(true); }
    },1000);
  }

  function preloadImage(){
    const img = new Image();
    img.onload = ()=>{ if(board) board.style.backgroundImage = `url('${img.src}')`; if(finalImage) finalImage.src = img.src; };
    img.onerror = ()=>{ console.warn('Error cargando imagen'); };
    img.src = 'https://www.uautonoma.cl/content/uploads/2023/07/maltrato-infantil-1.jpg';
  }

  function createBoard(){
    if(!board) return;
    board.innerHTML='';
    for(let i=0;i<16;i++){
      const tile = document.createElement('div');
      tile.className='tile';
      tile.dataset.index = i;
      tile.addEventListener('click', ()=> startQuiz(tile));
      board.appendChild(tile);
    }
  }

  function startQuiz(tile){
    if(!quizContainer || quizContainer.style.display==='block' || tile.classList.contains('revealed')) return;
    if(availableQuestions.length===0) return;
    const idx = Math.floor(Math.random()*availableQuestions.length);
    const q = availableQuestions.splice(idx,1)[0];
    quizQuestion.textContent = q.q;
    optionsDiv.innerHTML='';
    q.o.forEach(opt=>{
      const btn = document.createElement('button');
      btn.className='option';
      btn.textContent = opt;
      btn.addEventListener('click', ()=> checkAnswer(opt,q.a,tile));
      optionsDiv.appendChild(btn);
    });
    quizContainer.style.display='block';
    questionStart = Date.now();
  }

  function checkAnswer(selected, correct, tile){
    const timeTaken = (Date.now()-questionStart)/1000;
    if(selected===correct){
      let points=40;
      if(timeTaken<5) points+=20;
      else if(timeTaken<10) points+=15;
      else if(timeTaken<20) points+=10;
      score+=points; if(score>1000) score=1000; updateHUD();
      tile.classList.add('revealed'); revealedTiles++;
      if(revealedTiles===16){ score+=40; if(score>1000)score=1000; clearInterval(gameTimer); endGame(false); }
    }
    if(quizContainer) quizContainer.style.display='none';
  }

  function endGame(byTime=false){
    if(gameTimer) clearInterval(gameTimer);
    let msg='';
    if(byTime) msg='Se acabó el tiempo. ¡Buen intento!';
    else if(score>=800) msg='¡Excelente compromiso!';
    else if(score>=500) msg='¡Muy bien, sigues aprendiendo y apoyando!';
    else msg='¡Puedes mejorar, sigue intentándolo!';

    const timePlayed = Math.floor((Date.now()-gameStart)/1000);
    if(finalScore) finalScore.textContent = `${playerName || 'Jugador'}, tu puntaje: ${score}/1000`;
    if(finalMessage) finalMessage.textContent = msg + ` Tiempo jugado: ${timePlayed}s`;
    if(finalPanel) finalPanel.style.display='block';
  }

  function downloadCertificate(){
    try{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation: 'landscape'});
      doc.setFontSize(22); doc.setTextColor(0,128,128);
      doc.text('CERTIFICADO DE COMPROMISO', 20, 20);
      doc.setFontSize(14); doc.setTextColor(0,0,0);
      doc.text(`Otorgado a: ${playerName || 'Jugador'}`, 20, 40);
      doc.text(`Puntaje final: ${score}/1000`, 20, 56);
      const played = Math.floor((Date.now()-gameStart)/1000);
      doc.text(`Tiempo jugado: ${played} segundos`, 20, 72);
      const level = score>=800? 'Excelente defensor' : (score>=500? 'Buen esfuerzo' : 'Sigue aprendiendo');
      doc.text(`Nivel: ${level}`, 20, 88);
      doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 20, 104);
      doc.setFontSize(10); doc.text('Unidos por la protección de la niñez', 20, 120);
      doc.save('certificado_compromiso.pdf');
    }catch(e){ console.error('PDF error', e); alert('Error al generar certificado.'); }
  }

  function rotateMessages(){
    if(!leftMsg || !rightMsg) return;
    const msgs = ['Tu voz tiene poder','No guardes silencio','Habla con un adulto de confianza','Tu cuerpo merece respeto','Denuncia, no estás solo'];
    let idx=0; leftMsg.style.opacity=0; rightMsg.style.opacity=0;
    setInterval(()=>{
      leftMsg.style.opacity=0; rightMsg.style.opacity=0;
      setTimeout(()=>{
        leftMsg.textContent = msgs[idx%msgs.length];
        rightMsg.textContent = msgs[(idx+1)%msgs.length];
        leftMsg.style.opacity=1; rightMsg.style.opacity=1; idx+=2;
      },400);
    },5000);
  }

  // --- start function (global, safe) ---
  function startGameFromModal(){
    // ensure DOM refs exist
    initDOMRefs();

    playerName = (playerNameInput && playerNameInput.value.trim()) || 'Jugador';
    if(nameModal) nameModal.style.display='none';

    // reset
    score = 0; timeLeft = 180; revealedTiles = 0; availableQuestions = [...questions];
    if(finalPanel) finalPanel.style.display='none';
    updateHUD();

    preloadImage();
    createBoard();
    startGameTimer();
    rotateMessages();
  }

  // expose to window in case inline onclick is present
  window.startGameFromModal = startGameFromModal;

  // --- attach listeners after DOM loaded ---
  document.addEventListener('DOMContentLoaded', ()=>{
    initDOMRefs();
    if(startBtn) startBtn.addEventListener('click', startGameFromModal);
    if(downloadBtn) downloadBtn.addEventListener('click', downloadCertificate);
    // prepare available questions but do not start
    availableQuestions = [...questions];
  });
</script>
</body>
</html>
